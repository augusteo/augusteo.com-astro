---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import ImageLightbox from "../components/ImageLightbox.astro";
import { Image } from "astro:assets";
import { ViewTransitions } from "astro:transitions";
import type { ImageMetadata } from "astro";
import "../styles/global.css";

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  heroImage?: ImageMetadata;
  heroAlt: string;
  category: string;
  tags?: string[];
  firstContentImage?: string;
}

const { title, description, pubDate, heroImage, heroAlt, category, tags, firstContentImage } = Astro.props;

const formattedDate = pubDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={title} description={description} image={heroImage?.src || firstContentImage} />
    <ViewTransitions />
  </head>
  <body>
    <!-- SVG Filters for watercolor effects on images -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" aria-hidden="true">
      <defs>
        <!-- Organic watercolor edge filter - subtle displacement -->
        <filter id="watercolor-soft" x="-20%" y="-20%" width="140%" height="140%">
          <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="3" seed="1" result="noise"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="6" xChannelSelector="R" yChannelSelector="G"/>
        </filter>
        <!-- More dramatic organic edge -->
        <filter id="watercolor-medium" x="-20%" y="-20%" width="140%" height="140%">
          <feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="4" seed="15" result="noise"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="8" xChannelSelector="R" yChannelSelector="G"/>
        </filter>
        <!-- Heavy organic distortion -->
        <filter id="watercolor-heavy" x="-20%" y="-20%" width="140%" height="140%">
          <feTurbulence type="fractalNoise" baseFrequency="0.025" numOctaves="4" seed="42" result="noise"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="10" xChannelSelector="R" yChannelSelector="G"/>
        </filter>
      </defs>
    </svg>
    <Header />

    <article>
      <!-- Hero Image -->
      {heroImage && (
        <div class="post-hero">
          <Image
            src={heroImage}
            alt={heroAlt}
            widths={[800, 1200, 1600, 2000]}
            sizes="100vw"
            loading="eager"
            decoding="async"
          />
        </div>
      )}

      <!-- Header (overlaps hero) -->
      <header class={`post-header ${!heroImage ? 'no-hero' : ''}`}>
        <span class="category" data-category={category}>{category}</span>
        <h1>{title}</h1>
        <div class="meta">
          <span>{formattedDate}</span>
          {tags && tags.length > 0 && (
            <span>{tags.join(", ")}</span>
          )}
        </div>
      </header>

      <!-- Content -->
      <div class="post-content prose">
        <slot />
      </div>
    </article>

    <Footer />
    <ImageLightbox />
    <!-- Simple Analytics (privacy-first) -->
    <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
  </body>
</html>

<style>
  .post-hero {
    position: relative;
    min-height: 350px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    justify-content: center;
    background: var(--color-paper);
  }

  .post-hero img {
    width: 100%;
    height: auto;
    max-height: 80vh;
    object-fit: contain;
  }

  /* Watercolor fade at bottom */
  .post-hero::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 200px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' preserveAspectRatio='none'%3E%3Cdefs%3E%3ClinearGradient id='fadeGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23fdfbf7;stop-opacity:0'/%3E%3Cstop offset='100%25' style='stop-color:%23fdfbf7;stop-opacity:1'/%3E%3C/linearGradient%3E%3Cfilter id='heroFade'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.02' numOctaves='2'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='15'/%3E%3C/filter%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23fadeGrad)' filter='url(%23heroFade)'/%3E%3C/svg%3E");
    background-size: 100% 100%;
  }

  .post-header {
    max-width: var(--content-width);
    margin: -100px auto 0;
    padding: 0 2rem;
    position: relative;
    z-index: 10;
  }

  .post-header.no-hero {
    margin-top: 6rem;
  }

  .category {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    padding: 0.35rem 0.8rem;
    display: inline-block;
    margin-bottom: 1rem;
    position: relative;
  }

  .category::before {
    content: "";
    position: absolute;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 30'%3E%3Cdefs%3E%3Cfilter id='headerCat'%3E%3CfeTurbulence baseFrequency='0.04'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='4'/%3E%3C/filter%3E%3C/defs%3E%3Cellipse cx='40' cy='15' rx='38' ry='13' fill='%2387ceeb' opacity='0.6' filter='url(%23headerCat)'/%3E%3C/svg%3E");
    background-size: 100% 100%;
    z-index: -1;
  }

  .category[data-category="tech"]::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 30'%3E%3Cdefs%3E%3Cfilter id='headerCatTech'%3E%3CfeTurbulence baseFrequency='0.04'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='4'/%3E%3C/filter%3E%3C/defs%3E%3Cellipse cx='40' cy='15' rx='38' ry='13' fill='%238fbc8f' opacity='0.6' filter='url(%23headerCatTech)'/%3E%3C/svg%3E");
  }

  .category[data-category="books"]::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 30'%3E%3Cdefs%3E%3Cfilter id='headerCatBooks'%3E%3CfeTurbulence baseFrequency='0.04'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='4'/%3E%3C/filter%3E%3C/defs%3E%3Cellipse cx='40' cy='15' rx='38' ry='13' fill='%23cd853f' opacity='0.6' filter='url(%23headerCatBooks)'/%3E%3C/svg%3E");
  }

  .category[data-category="philosophy"]::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 30'%3E%3Cdefs%3E%3Cfilter id='headerCatPhil'%3E%3CfeTurbulence baseFrequency='0.04'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='4'/%3E%3C/filter%3E%3C/defs%3E%3Cellipse cx='40' cy='15' rx='38' ry='13' fill='%23deb887' opacity='0.6' filter='url(%23headerCatPhil)'/%3E%3C/svg%3E");
  }

  .post-header h1 {
    font-family: var(--font-hand);
    font-size: 3.2rem;
    font-weight: 600;
    line-height: 1.1;
    margin-bottom: 1rem;
  }

  .meta {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-ink-light);
    margin-bottom: 2rem;
  }

  .post-content {
    max-width: var(--content-width);
    margin: 0 auto;
    padding: 2rem 2rem 4rem;
  }

  @media (max-width: 768px) {
    .post-header h1 {
      font-size: 2.2rem;
    }

    .post-header {
      margin-top: -60px;
    }

    .post-header.no-hero {
      margin-top: 4rem;
    }
  }
</style>
